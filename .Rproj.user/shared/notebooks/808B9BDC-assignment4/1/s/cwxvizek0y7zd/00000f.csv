"0","# Helper: coerce factor levels in newdata to training levels stored in the fit"
"0","prep_newdata_for <- function(newdata, fit) {"
"0","  nd <- newdata"
"0","  if (!is.null(fit$xlevels)) {"
"0","    for (nm in names(fit$xlevels)) {"
"0","      if (nm %in% names(nd)) {"
"0","        nd[[nm]] <- factor(nd[[nm]], levels = fit$xlevels[[nm]])"
"0","      }"
"0","    }"
"0","  }"
"0","  droplevels(nd)"
"0","}"
"0",""
"0","# 1) Test set for severity evaluation (only positive claims)"
"0","test_claimsize_df <- test_data_imputed |>"
"0","  dplyr::filter(CLAIMS > 0)"
"0",""
"0",""
"0",""
"0","# 2) Align test data to each model"
"0","test_for_gamma    <- prep_newdata_for(test_claimsize_df, claimsize.2.gamma)"
"0","test_for_lognorm  <- prep_newdata_for(test_claimsize_df, claimsize.2.lognormal)"
"0",""
"0","# 3) Predictions"
"0","# Gamma(log): already on the dollar scale"
"0","pred_gamma <- predict(claimsize.2.gamma, newdata = test_for_gamma, type = ""response"")"
"0",""
"0","# Lognormal (lm on log(CLAIMS)): use smearing correction"
"0","pred_log <- predict(claimsize.2.lognormal, newdata = test_for_lognorm)  # predicts log(CLAIMS)"
"0",""
"0","# Duanâ€™s smearing factor from TRAINING residuals of the log model"
"0","sf <- mean(exp(residuals(claimsize.2.lognormal)), na.rm = TRUE)"
"0","pred_lognormal <- exp(pred_log) * sf"
"0",""
"0",""
"0","# 4) Metrics"
"0","actual_claims <- test_for_lognorm$CLAIMS"
"0",""
"0","rmse <- function(a, p) sqrt(mean((a - p)^2, na.rm = TRUE))"
"0","mae  <- function(a, p) mean(abs(a - p), na.rm = TRUE)"
"0",""
"0","rmse_gamma <- rmse(actual_claims, pred_gamma)"
"0","mae_gamma  <- mae(actual_claims, pred_gamma)"
"0",""
"0","rmse_lognormal <- rmse(actual_claims, pred_lognormal)"
"0","mae_lognormal  <- mae(actual_claims, pred_lognormal)"
"0",""
"0","comparison_df <- data.frame("
"0","  Model = c(""Gamma GLM"", ""Lognormal (lm + smearing)""),"
"0","  RMSE  = c(rmse_gamma, rmse_lognormal),"
"0","  MAE   = c(mae_gamma,  mae_lognormal)"
"0",")"
"0","print(comparison_df)"
