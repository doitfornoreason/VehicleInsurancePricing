"0","# Helpers"
"0","prep_newdata_for <- function(newdata, fit) {"
"0","  nd <- newdata"
"0","  if (!is.null(fit$xlevels)) {"
"0","    for (nm in names(fit$xlevels)) if (nm %in% names(nd)) {"
"0","      nd[[nm]] <- factor(nd[[nm]], levels = fit$xlevels[[nm]])"
"0","    }"
"0","  }"
"0","  droplevels(nd)"
"0","}"
"0","log_loss <- function(y, p, eps = 1e-15) {"
"0","  p <- pmin(pmax(p, eps), 1 - eps)"
"0","  -mean(y * log(p) + (1 - y) * log(1 - p), na.rm = TRUE)"
"0","}"
"0","brier <- function(y, p) mean((p - y)^2, na.rm = TRUE)"
"0","calibration_df <- function(y, p, bins = 10, label = ""model"") {"
"0","  brks <- quantile(p, probs = seq(0, 1, length.out = bins + 1), na.rm = TRUE)"
"0","  g <- cut(p, breaks = unique(brks), include.lowest = TRUE)"
"0","  dplyr::summarise(dplyr::group_by(data.frame(y, p, g), g),"
"0","                   mean_p = mean(p, na.rm = TRUE),"
"0","                   obs   = mean(y, na.rm = TRUE),"
"0","                   n     = dplyr::n()) |>"
"0","    mutate(model = label)"
"0","}"
"0",""
"0","# Prepare test data for each model (handles factors/levels)"
"0","test_logit  <- prep_newdata_for(test_data_imputed, outcome.2.logistic)"
"0","test_probit <- prep_newdata_for(test_data_imputed, outcome.2.probit)"
"0",""
"0","# Predictions"
"0","y  <- test_logit$OUTCOME"
"0","p_logit  <- predict(outcome.2.logistic, newdata = test_logit,  type = ""response"")"
"0","p_probit <- predict(outcome.2.probit,   newdata = test_probit, type = ""response"")"
"0",""
"0","# Keep rows where both models produce probabilities"
"0","keep <- is.finite(p_logit) & is.finite(p_probit) & !is.na(y)"
"0","y <- y[keep]; p_logit <- p_logit[keep]; p_probit <- p_probit[keep]"
"0",""
"0","# Build ROC objects with pROC"
"0","roc_logit  <- pROC::roc(y, p_logit,  quiet = TRUE)"
"0","roc_probit <- pROC::roc(y, p_probit, quiet = TRUE)"
"0",""
"0","# Get numeric AUCs (either of these styles works)"
"0","auc_logit  <- as.numeric(pROC::auc(roc_logit))"
"0","auc_probit <- as.numeric(pROC::auc(roc_probit))"
"0","# or:"
"0","# auc_logit  <- as.numeric(roc_logit$auc)"
"0","# auc_probit <- as.numeric(roc_probit$auc)"
"0",""
"0","metrics <- data.frame("
"0","  Model   = c(""Logit"", ""Probit""),"
"0","  AUC     = c(auc_logit, auc_probit),"
"0","  LogLoss = c(log_loss(y, p_logit),  log_loss(y, p_probit)),"
"0","  Brier   = c(brier(y, p_logit),     brier(y, p_probit))"
"0",")"
"0","print(metrics, row.names = FALSE)"
